#textdomain wesnoth-nrr

[scenario]
    id=08_The_Underlevels
    name= _ "The Underlevels"
    map_file=08_The_Underlevels.map
    {TURNS 50 45 40}
    next_scenario=09_Pandemonium
    victory_when_enemies_defeated=no
    {XP_MODIFIER_NRR}
    {NRR_LOAD_RESOURCES}
    {NRR_ENCHANTING_SYSTEM}

    {UNDERGROUND}
    {DEFAULT_MUSIC_PLAYLIST}

    [side]
        side=1
        controller=human
        {CHARACTER_STATS_TALLIN}
        {FLAG_VARIANT knalgan}
        team_name="player"
        user_team_name= _ "Knalgan Alliance"
        shroud=yes
        fog=yes
        share_vision=all
        {GOLD 240 220 200}
        recruit={KNALGAN_ALLIANCE_RECRUIT_LIST_FULL}
    [/side]

    # Kal Kartha side
    # side for boss unit
    [side]
        side=2
        controller=ai

        # boss side
        {NO_RECRUITMENT}

        {NO_ECONOMY}
        {HIDDEN_TEAM}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        no_leader=yes

        {NEUTRAL_AI_PARAMS}
    [/side]

    [side]
        side=3
        controller=ai

        recruit={KAL_KARTHA_MASKED_DWAVRES_VETERANS}

        gold=0 # Will change when the side is activated
        {INCOME 4 6 8}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        type=Dwarvish Masked Lord
        id=Dufon
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf4.png~RIGHT()
        canrecruit=yes

        facing=nw

        # dwarves are neutral alignment lol
        {NEUTRAL_AI_PARAMS}

        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter,fighter,mixed fighter
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai

        recruit={KAL_KARTHA_MASKED_DWAVRES_VETERANS}

        gold=0 # Will change when the side is activated
        {INCOME 6 9 12}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        type=Dwarvish Masked Lord
        id=Aragoth
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf2.png~RIGHT()
        canrecruit=yes

        facing=sw

        {NEUTRAL_AI_PARAMS}

        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter,fighter,mixed fighter
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai

        recruit={KAL_KARTHA_MASKED_DWAVRES_ELITES}

        gold=0 # Will change when the side is activated
        {INCOME 6 9 12}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        type=Dwarvish Masked Lord
        id=Dranath
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf3.webp~RIGHT()
        canrecruit=yes

        facing=nw

        {NEUTRAL_AI_PARAMS}

        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter,fighter,mixed fighter
        [/ai]
    [/side]

    # side for spawned enemy units
    [side]
        side=6
        controller=ai
        no_leader=yes

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        shroud=yes
        fog=yes
        share_vision=none

        {NO_ECONOMY}
        # you dont need to see this side
        {HIDDEN_TEAM}
        {NO_RECRUITMENT}

        {NEUTRAL_AI_PARAMS}
    [/side]

    # side for prisoners
    [side]
        side=7
        controller=ai
        no_leader=yes

        {FLAG_VARIANT ragged}
        team_name="player"
        user_team_name= _ "Knalgan Alliance"
        color=white

        shroud=yes
        fog=yes
        share_vision=none

        {NO_ECONOMY}
        {HIDDEN_TEAM}
        {NO_RECRUITMENT}

        {NEUTRAL_AI_PARAMS}
    [/side]

    # Scenery
    {PLACE_IMAGE "scenery/rune2.png" 38 21}
    {PLACE_IMAGE "scenery/rune4.png" 38 23}
    {PLACE_IMAGE "scenery/rune2.png" 46 6}
    {PLACE_IMAGE "scenery/rune4.png" 44 36}

    {PLACE_IMAGE "items/bones.png" 19 5}
    {PLACE_IMAGE "items/bones.png" 25 5}

    {PLACE_IMAGE "items/chest.png" 48 13}
    {PLACE_IMAGE "items/chest.png" 12 29}

    # Starting villages
    {STARTING_VILLAGES 1 4}
    {STARTING_VILLAGES 2 9}
    {STARTING_VILLAGES 3 5}
    {STARTING_VILLAGES_AREA 3 23 27 4}
    {STARTING_VILLAGES_AREA 3 35 28 1}
    {STARTING_VILLAGES_AREA 3 23 13 4}
    {STARTING_VILLAGES 4 6}
    {STARTING_VILLAGES 5 6}

    # prestart
    [event]
        name=prestart

        # recall heroes
        {RECALL "Aiglondur"}
        {RECALL_LOYALS}

        {MODIFY_UNIT (side=1) facing se}

        # define vars
        {VARIABLE runes_activated 0}
        {VARIABLE rune_one 0}
        {VARIABLE rune_two 0}
        {VARIABLE rune_three 0}

        # three conditions to meet here
        {VARIABLE enemies_defeated no}
        {VARIABLE vip_prisoners_rescued no}
        {VARIABLE boss_defeated no}

        # define objectives

        # spawn masked dwarven guards
        {MASKED_DWARF 6 "Dwarvish Masked Stalwart" 23 20}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 24 19}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 24 20}

        {MASKED_DWARF 6 "Dwarvish Masked Stalwart" 28 26}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 28 25}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 27 26}

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 30 11}
        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 33 12}

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 29 31}
        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 25 32}

        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 14 3}
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 18 4}

        #ifdef EASY
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 18 4}
        #else
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 15 5}
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 17 3}
        #endif

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 10  8}
        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 12  6}

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 23  8}

        {GENERIC_UNIT 6 "Abomination" 12 30}
        {GENERIC_UNIT 6 "Abomination" 14 31}
        {GENERIC_UNIT 6 "Abomination" 18 28}
        {GENERIC_UNIT 6 "Abomination" 20 30}

        {GENERIC_UNIT 6 "Flesh Golem" 15 30}

        [micro_ai]
            side=6
            ai_type=lurkers
            action=add

            [filter]
                type=Abomination,Flesh Golem
            [/filter]
            [filter_location]
                terrain=U*
            [/filter_location]
            [filter_location_wander]
                terrain=U*
            [/filter_location_wander]
        [/micro_ai]

        # shrooms
        # 50% level 1
        # 30% level 2
        # 20% level 3
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 9 30}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 13 33}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 22 30}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 21 27}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 24 29}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 36 38}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Shroom") 39 33}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 28 36}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 34 29}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 35 20}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 34 16}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 4 21}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom")  9  9}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 12  5}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 49 12}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 50 13}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 41 15}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 42 16}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Shroom") 42 23}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 46 20}

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 48 20}
        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 48 24}

        {GENERIC_UNIT 2 "Clockwork Ballista" 51 19}
        {GENERIC_UNIT 2 "Clockwork Ballista" 52 18}

        {GENERIC_UNIT 2 "Clockwork Ballista" 51 26}
        {GENERIC_UNIT 2 "Clockwork Ballista" 52 26}

        {GENERIC_UNIT 2 "Clockwork Ballista" 53 20}
        {GENERIC_UNIT 2 "Clockwork Ballista" 53 25}

        {GENERIC_UNIT 2 "Clockwork Ballista" 54 21}
        {GENERIC_UNIT 2 "Clockwork Ballista" 54 23}

        {GENERIC_UNIT 2 "Clockwork Ballista" 56 19}
        {GENERIC_UNIT 2 "Clockwork Ballista" 56 25}

        [unit]
            side=6
            type=Dwarvish Masked Berserker
            id=library_guard
            name= _ "Masked Dwarf"
            x,y=5,4
            random_traits=yes
        [/unit]

        {ZONE_GUARDIAN_MAI 6 add (
            [filter]
                side=6
            [/filter]
        ) (
            [filter_location]
                x=  3,  4,  5,  6,  7,  8
                y=4-5,3-5,3-6,2-5,3-5,3-4
            [/filter_location]
        ) ()}

        # spawn prisoners
        # can be human/elf/dwarf/orc/drake/goblin/troll/saurian
        # anything that can be considered a dirtgrubber

        # spawn Eryssa and Elenia
        [unit]
            side=8
            x,y=12,11
            {CHARACTER_STATS_ERYSSA}
        [/unit]

        [unit]
            side=8
            x,y=14,10
            {CHARACTER_STATS_ELENIA}
        [/unit]

        # random elves
        {RANDOM_SPAWN 7 ("Elvish Fighter,Elvish Archer,Elvish Shaman") 18 10}
        {RANDOM_SPAWN 7 ("Elvish Fighter,Elvish Archer,Elvish Shaman") 26 5}

        # northerners prisoners
        {RANDOM_SPAWN 7 ("Orcish Grunt,Orcish Archer,Orcish Assassin,Goblin Impaler, Goblin Rouser,Troll Whelp") 40 28}
        {RANDOM_SPAWN 7 ("Orcish Grunt,Orcish Archer,Orcish Assassin,Goblin Impaler,Goblin Rouser,Troll Whelp") 46 30}

        # knalgan prisoners
        # these are the only ones who will flip to your side
        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUIT_LIST})  9 26}
        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUIT_LIST}) 13 25}
        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUIT_LIST})  8 32}

        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUIT_LIST}) 16 35}
        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUIT_LIST}) 21 34}

        # add micro_AI (if needed)

        [unit]
            side=2
            x,y=58,22
            {IS_HERO}
            # unique boss type for this scenario
            type=Clockwork Knight
            id=clockwork_knight_boss
            # short for Zeta Lambda Epsilon Xemma
            name=_"Project ZLEX"
            [modifications]
                {TRAIT_BOSS_CLASS}
                [object]
                    id=boss_buff_zlex
                    silent=yes
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_LEADERSHIP}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [micro_ai]
            side=2
            ai_type=bloodlust
            action=add
            [filter]
                id=clockwork_knight_boss
            [/filter]
            [filter_location]
                x=   48,   49,   50,   51,   52,   53,   54,   55,   56,   57
                y=20-24,20-25,19-25,19-26,18-26,18-27,18-26,18-27,18-25,20-25
            [/filter_location]
        [/micro_ai]

        # minions
        {GENERIC_UNIT 2 "Clockwork Armoured Golem" 50 21}
        {GENERIC_UNIT 2 "Clockwork Armoured Golem" 50 23}

        {GENERIC_UNIT 2 "Clockwork Berserker" 52 21}
        {GENERIC_UNIT 2 "Clockwork Berserker" 52 23}

        {GENERIC_UNIT 2 "Clockwork Golem" 56 21}
        {GENERIC_UNIT 2 "Clockwork Golem" 56 23}

        {MINIONS_MICRO_AI 2 add (
            [filter]
                id=clockwork_knight_boss
            [/filter]
        ) (
            [filter_second]
                type=Clockwork Armoured Golem,Clockwork Golem,Clockwork Berserker
            [/filter_second]
        ) 56000 (
            messenger_death_chance=0.0
            enemy_death_chance=0.5
            # had to add these here or else AI would have a seizure
            waypoint_x=1
            waypoint_y=1
        )}
    [/event]

    # Hidden events
    # copied code from the original THoT

    # Small unit hitpoint bonuses
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=19,5
        [/filter]

        [message]
            speaker=unit
            message= _ "Someone died here."
        [/message]

        # Secret easter egg bonus
        # Give a unit 3 extra hp

        [object]
            [filter]
                x,y=$x1,$y1
            [/filter]
            duration=forever
            silent=yes
            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=3
            [/effect]
        [/object]
    [/event]
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=25,5
        [/filter]

        [message]
            speaker=unit
            message= _ "Poor guy didn’t make it."
        [/message]

        # Secret easter egg bonus
        # Give a unit 3 extra hp

        [object]
            [filter]
                x,y=$x1,$y1
            [/filter]
            duration=forever
            silent=yes
            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=3
            [/effect]
        [/object]
    [/event]

    # Gold
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=48,13
        [/filter]

        [message]
            speaker=unit
            message= _ "There’s some gold in here!"
        [/message]

        [gold]
            side=1
            amount={ON_DIFFICULTY 50 40 30}
        [/gold]
        {PLACE_IMAGE "items/chest-open.png" 48 13}
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=12,29
        [/filter]

        [message]
            speaker=unit
            message= _ "I found some gold!"
        [/message]

        [gold]
            side=1
            amount={ON_DIFFICULTY 50 40 30}
        [/gold]
        {PLACE_IMAGE "items/chest-open.png" 12 29}
    [/event]

    # sighted events
    # copied from orignal THoT

    [event]
        name=sighted
        [filter]
            side=3
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "The dirtgrubber-friends have come! Slay them all!"
        [/message]

        # Activate side 3
        [gold]
            side=3
            amount={ON_DIFFICULTY 30 45 60}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Dufon
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Dufon
            message= _ "You shall never pass through here! The doors I guard are sealed by the power of the Hammer itself."
        [/message]

        [message]
            speaker=second_unit
            message= _ "You won’t stop us!"
        [/message]

        [gold]
            side=3
            amount={ON_DIFFICULTY 40 55 70}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Aragoth
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Aragoth
            message= _ "Your path forward ends here!"
        [/message]

        # Give side 4 some gold
        [gold]
            side=4
            amount={ON_DIFFICULTY 60 80 100}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Dranath
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Dranath
            message= _ "The dirtgrubbers have come! Stop their advance!"
        [/message]

        # Give side 5 some gold
        [gold]
            side=5
            amount={ON_DIFFICULTY 60 80 100}
        [/gold]
    [/event]

    # gate events
    # starting gate
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=16,17
            y=18,18
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Aiglondur
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=Angarthing
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=unit
                    message= _ "The gates are locked. I will have to break them open by force!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "The gates are locked!"
                [/message]

                [message]
                    speaker=Aiglondur
                    message= _ "Force them open!"
                [/message]

                [message]
                    speaker=unit
                    message= _ "Yes, sir!"
                [/message]
            [/else]
        [/if]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x=18,17
            y=18,19
            terrain=Ur^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Angarthing
            message= _ "Let us proceed onward."
        [/message]
    [/event]

    # gate to first rune
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=42,5
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Aiglondur
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=Angarthing
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=unit
                    message= _ "There’s something behind this door. I shall break it down!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "There’s something behind this door."
                [/message]

                [message]
                    speaker=Aiglondur
                    message= _ "Break it down!"
                [/message]
            [/else]
        [/if]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=43,6
            terrain=Ur^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    # gate to second rune
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=40,37
        [/filter]

        [message]
            speaker=unit
            message= _ "It looks like there is a rune behind this gate!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=41,37
            terrain=Ur^Pr\o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    # gate to third rune
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=9,10
        [/filter]

        [message]
            speaker=unit
            message= _ "It looks like there is a rune behind this gate!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=8,10
            terrain=Ur^Pr\o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    {RENAME_MASKED_DWARVES 3,4,5}
    
    # Setting: within Kal Kartha
    # Tallin and co explore the winding underlevels under Kal Kartha proper, discovering the horrors of Karrag's experiments.
    {HERO_DEATH_EVENTS}
[/scenario]
